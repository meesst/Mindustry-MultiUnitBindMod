# Mindustry-MultiUnitBindMod

一个为Mindustry游戏添加多单位绑定功能的逻辑扩展模组，支持单位批量控制、共享组管理和智能解绑等高级功能。

## 功能介绍

### ubindgroup 指令
该指令允许玩家同时绑定多个同类型单位，并可以控制最大绑定数量。支持两种工作模式，适用于不同的控制场景。

**语法:**
```
ubindgroup unitType maxCount varUnit varIndex [groupName] [mode]
```

**参数说明:**
- `unitType`: 单位类型，用于筛选要绑定的单位。
- `maxCount`: 最大绑定数量，限制同时绑定的单位数量
- `varUnit`: 存储单位对象的变量名
- `varIndex`: 存储当前单位索引的变量名
- `groupName`（可选）: 共享组名称，用于创建或加入共享单位组
- `mode`（可选）: 工作模式，1为正常抓取模式，2为共享组访问模式

### 核心功能特性

#### 单位绑定与控制
- **多单位绑定**: 同时绑定多个同类型单位，实现批量控制
- **类型筛选**: 支持特定单位类型或所有可控制单位的筛选
- **数量限制**: 可设置最大绑定数量，防止过度占用单位资源
- **循环访问**: 通过索引变量实现对绑定单位的循环访问和控制

#### 共享组机制
- **独立组**: 默认模式，每个控制器拥有独立的单位池
- **共享组**: 通过指定组名，多个控制器可以共享同一单位池
- **模式切换**: 
  - **模式1**: 正常抓取逻辑，控制器主动抓取并锁定单位
  - **模式2**: 共享组访问模式，无需抓取单位，直接访问共享组内单位

#### 单位解绑与资源管理
- **自动解绑**: 当参数变化或单位无效时，自动解绑相关单位
- **内存清理**: 定期清理未使用的单位组和无效控制器
- **资源释放**: 解绑时正确释放单位控制，使单位恢复正常状态

### 使用场景
- **编队控制**: 同时控制多个同类型单位执行相同任务
- **分工协作**: 通过共享组实现不同控制器对单位的协同管理
- **资源优化**: 根据需求动态调整绑定单位数量和类型
- **复杂逻辑**: 与其他逻辑指令配合，实现高级单位控制策略

### 交互增强功能
- **参数可视化选择**: 单位类型参数支持通过按钮打开选择面板，直观显示可控制的单位类型图标
- **参数悬浮提示**: 每个参数都有详细的悬浮提示文本，帮助用户理解参数的作用和用法
- **数据持久化**: 指令支持保存到逻辑芯片和从逻辑芯片加载，修复了之前的保存问题
- **复制到剪贴板**: 支持将包含ubindgroup指令的逻辑代码复制到剪贴板

## 技术实现细节

### 核心类结构
- `LUnitBindGroup`: 主类，包含所有单位绑定相关逻辑
- `UnitBindGroupStatement`: 逻辑语句定义类，处理UI展示和指令构建
- `UnitBindGroupInstruction`: 指令执行类，实现具体的绑定和控制逻辑

### 数据管理
- **独立组管理**: 通过`individualGroups`映射存储每个控制器的独立单位组
- **共享组管理**: 通过`sharedGroups`映射管理所有共享单位组
- **参数缓存**: 使用`paramCaches`缓存指令参数，优化性能
- **单位状态追踪**: 记录单位的控制状态，确保单位不会被重复控制

### 自动清理机制
- 定期清理未使用的单位组和无效控制器
- 当组名变化或控制器失效时，自动清理相关资源
- 支持共享组的引用计数，当没有控制器使用时自动移除

## 安装方法
1. 编译mod生成jar文件
2. 将jar文件放入Mindustry游戏的mods文件夹
3. 启动游戏，在模组列表中启用该mod

## 使用示例

### 基本用法 - 独立控制多个单位
```
ubindgroup @poly 10 unit i
ucontrol unit move 500 500
```

### 高级用法 - 共享组协作
控制器1:
```
ubindgroup @poly 5 unit i "defense-group" 1
```

控制器2:
```
ubindgroup @poly 0 unit i "defense-group" 2
ucontrol unit patrol 300 300 700 700
```

## 开发信息
作者: meesst
版本: 1.0
兼容性: Mindustry 151.1+

## 注意事项
- 确保合理设置最大绑定数量，避免过多占用单位资源
- 在共享组模式下，多个控制器共享单位池，请注意协调控制逻辑
- 使用模式2时，确保已经有控制器在模式1下创建并填充了共享组
- 当不再需要控制单位时，建议显式解绑以释放资源
