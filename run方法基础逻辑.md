
# 参数描述：
type：要绑定的单位类型
count：要绑定的单位数量
mode：绑定模式，可选值:Capture-unit（捕获单位）或visiting-unit（访问单位）
group：单位绑定组的名称，用于识别不同的单位组，group="stand-alone"时代表(独立单位组:当前逻辑块独立使用的单位组),group!="stand-alone"时代表(共享单位组:可以在多个逻辑块中共享使用的单位组)
unitVar：用于存储当前单位的变量名,或错误提示
indexVar：用于存储单位索引的变量名（≥1）,错误返回-1
# run方法完整逻辑设计

## 核心功能概述
run方法是单位绑定系统的主执行方法，根据不同的模式执行访问或抓取单位的操作，同时处理各种错误情况，并通过unitVar和indexVar返回结果或错误信息。

## 完整执行流程（流水线设计）

```
开始
  │
  ├─► 1. 根据mode分流
  │     │
  │     ├─► visiting-unit模式
  │     │     ├─► 查找指定group的单位池（由UI管理，组必定存在）
  │     │     │     ├─► 检查组的使用状态
  │     │     │     │     ├─► 未使用：unitVar="组未被使用"，indexVar=-1，返回
  │     │     │     │     └─► 已使用：
  │     │     │     │           ├─► 单位池为空：unitVar="单位池为空"，indexVar=-1，返回
  │     │     │     │           └─► 单位池非空：使用该单位池
  │     │     └─► 单位池操作（不涉及绑定/解绑/维护）
  │     │           └─► 跳转到索引处理逻辑
  │     │
  │     └─► Capture-unit模式
  │           ├─► 处理单位池创建
  │           │     ├─► group="stand-alone"：获取独立单位池
  │           │     └─► group≠"stand-alone"：
  │           │     ├─► 检查共享单位池是否已被使用
  │           │     │     ├─► 已被使用：unitVar="组已被使用"，indexVar=-1，返回
  │           │     │     └─► 未被使用：使用该共享单位池
  │           │
  │           └─► 单位池维护
  │                 ├─► 检查池中单位数量是否满足count要求
  │                 │     └─► 不满足：调用绑定方法补充单位
  │                 ├─► 维护单位池，单位的存活和控制方的判断
  │                 └─► 检查维护后单位池是否为空
  │                       ├─► 单位池为空：
  │                       │     ├─► 更新指定组的使用状态为未使用
  │                       │     └─► unitVar="单位池为空"，indexVar=-1，返回
  │                       └─► 单位池非空：
  │                             ├─► 更新指定组的使用状态为已使用
  │                             └─► 继续
  │
  ├─► 2. 索引处理逻辑（适用于所有单位池，包括独立池和共享池）
  │     ├─► 获取单位池当前索引
  │     ├─► 索引取模确保在有效范围内（防止越界）
  │     ├─► 获取当前索引对应的单位
  │     ├─► 设置unitVar为当前单位
  │     ├─► 设置indexVar为当前索引+1（索引从1开始）
  │     └─► 索引递增（循环访问）
  │
  └─► 3. 返回结果
        └─► 返回unitVar和indexVar的值
结束
```

## 详细实现说明

### 1. visiting-unit模式处理
- **直接查找**：直接查找指定group的单位池
- **只读操作**：不涉及单位绑定、解绑或维护
- **错误处理**：
  - 组未使用：unitVar="组未被使用"，indexVar=-1
  - 单位池为空：unitVar="单位池为空"，indexVar=-1

### 2. Capture-unit模式处理
- **单位池管理**：
  - 独立单位池：每个逻辑块独有，直接获取
  - 共享单位池：多逻辑块共享，由UI玩家手动创建和管理，只需检查是否已被使用
- **单位池维护**：
  - 参考单位池维护方法
- **状态管理**：仅根据单位池维护结果动态更新单位池的使用状态和控制者

### 3. 索引处理逻辑（适用于所有单位池）
```
// 确保计数器在有效范围内循环（防止索引越界）
currentIndex %= unitPool.size();
// 获取当前索引对应的单位
unitVar = unitPool.get(currentIndex);
// 设置索引值（从1开始）
indexVar = currentIndex + 1;
// 索引递增，下次执行时将返回下一个单位
currentIndex++;
```

### 4. 错误处理机制
- **无符合条件**：unitVar="无符合条件单位"，indexVar=-1
- **组已使用**：unitVar="组已被使用"，indexVar=-1
- **组未使用**：unitVar="组未被使用"，indexVar=-1
- **单位池为空**：unitVar="单位池为空"，indexVar=-1（适用于visiting-unit模式和Capture-unit模式维护后）

### 5. 单位池使用状态管理
- **状态定义**：
  - 已使用状态：表示该单位池已被某个逻辑块绑定了单位并正在使用
  - 未使用状态：表示该单位池没有被绑定单位或已被重置
- **状态转换条件**：
  - 从未使用→已使用：在Capture-unit模式下，单位池维护后非空
  - 从已使用→未使用：
    1. 在Capture-unit模式下，单位池维护后为空
    2. 通过UI手动调用重置方法
    3. 通过UI手动调用删除方法
- **模式差异**：
  - visiting-unit模式：仅检查和使用已有状态，不改变单位池的使用状态
  - Capture-unit模式：根据绑定和维护结果动态更新单位池的使用状态
- **共享单位池特殊处理**：共享单位池的使用状态由系统统一管理，任何逻辑块都可以访问已使用的共享池，但只有在池未使用时才能进行绑定操作

### 6. 重要注意事项
- 重置方法、添加方法、删除方法仅用于UI手动维护，不在run方法中调用
- 访问模式不参与单位绑定、解绑和维护操作
- 抓取模式参与完整的绑定、解绑和维护流程
- 所有错误情况通过unitVar返回错误信息，indexVar返回-1
- 正常情况下indexVar返回的索引值从1开始递增

# 绑定方法：绑定指定类型（type），指定数量（count）到指定组索引（group）的单位池里。
> 注：绑定方法现在作为单位池维护的一部分被调用，当池中单位数量不满足count要求时自动执行。
## 绑定规则：
   1. 获取单位对象：
     - 参考`D:\Users\zhang\MYcode\Mindustry\Mindustry-151.1\core\src\mindustry\logic\LExecutor.java`第137-175行的UnitBindI方法
   2. 单位对象必须未被其他逻辑处理器控制
     - 参考`D:\Users\zhang\MYcode\Mindustry\Mindustry-151.1\core\src\mindustry\entities\comp\UnitComp.java`第281-285行的controlled方法，单位有效但是返回0的情况
1. 使用绑定规则绑定指定类型和指定数量单位到单位池
2. 预控制单位（将单位的控制方设置为当前逻辑处理器）
   - 参考`D:\Users\zhang\MYcode\Mindustry\Mindustry-151.1\core\src\mindustry\logic\LExecutor.java` 第287行-306行的 `checkLogicAI` 方法
   - 实现：调用该方法将单位控制权转移给逻辑处理器

3. 绑定结果处理：
   - 绑定成功：添加单位到对应的组索引（group）单位池里
   - 绑定失败：返回0（不添加单位到对应的组索引（group）单位池里）

# 解绑方法：解绑指定组索引（group）单位池里的所有单位或指定单位。
基础方法：参考`D:\Users\zhang\MYcode\Mindustry\Mindustry-151.1\core\src\mindustry\logic\LExecutor.java`第336-338行的unbind方法
1. 解绑所有单位：解绑指定组索引单位池里的所有单位
2. 解绑指定单位：解绑指定单位（通常是单位死亡或不再满足条件时调用）
3. 解绑后的单位处理：
   - 重置单位控制权
   - 从单位池中移除单位

# 重置方法：重置指定组索引的单位池，调用解绑方法解绑指定组索引的单位池里面所有单位。

# 添加方法：通过指定组索引，创建一个单位池。

# 删除方法：删除指定组索引的单位池，并调用解绑方法解绑单位池里面的所有单位。

# 单位池维护方法：单位池维护基于以下关键条件，确保单位池中的单位满足type和绑定规则条件，并在必要时更新使用状态
## 核心功能：
1. 不足时调用绑定方法补充单位
2. 清理不符合条件的单位
3. 检查池中单位数量是否满足count要求
4. 根据维护结果更新使用状态

1. 单位数量检查与补充：
- 检查池中单位数量是否满足count要求
- 如果不足，调用绑定方法补充单位到池中


2. 单位存活判断：
- 参考源代码：`d:\Users\zhang\MYcode\Mindustry\Mindustry-151.1\core\src\mindustry\entities\comp\HealthComp.java` 第16行的 `isValid()` 方法
- 判断条件：单位是否存活
- 实现：使用解绑方法从单位池里面过滤掉无效单位

3. 单位类型和控制方判断：
 - 参考`D:\Users\zhang\MYcode\Mindustry\Mindustry-151.1\core\src\mindustry\entities\comp\UnitComp.java`第281-285行的controlled方法，返回的控制方和builder.getVar("@this")进行比较
- 判断条件：
  - 单位的控制方是否等于当前逻辑处理器
- 实现：使用解绑方法从单位池里面过滤掉无效单位



4. 单位池使用状态更新：
- 维护后单位池为空：更新使用状态为未使用，设置单位池的使用对象为null
- 维护后单位池非空：更新使用状态为已使用，设置单位池的使用对象为当前逻辑处理器
- 仅在Capture-unit模式下进行状态更新

5. 特殊情况处理：
- 单位池完全为空：返回空结果
- 维护后单位池为空：更新使用状态为未使用并返回空结果

- 重复绑定检查：确保不会重复绑定同一单位
- 控制权冲突：当单位被其他逻辑处理器控制时，将其从单位池中移除

